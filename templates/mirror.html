{% extends "base.html" %}

{% block title %}{{ event.title }} - Strategy Mirror{% endblock %}

{% block content %}
<div class="flex flex-col lg:flex-row lg:space-x-6">
    <div class="flex-1 lg:max-w-[60%] space-y-6">
        <!-- Left Column: Event Mirror -->
        <!-- Event Header -->
        <div class="bg-white shadow rounded-lg p-6">
            <div class="flex items-start justify-between mb-4">
                <div class="flex items-start space-x-3">
                    <!-- Asset Logo -->
                    <div class="w-12 h-12 bg-gradient-to-br from-blue-500 to-purple-600 rounded-lg flex items-center justify-center flex-shrink-0">
                        {% if asset == "ETH" %}
                        <svg class="w-8 h-8 text-white" viewBox="0 0 256 417" fill="currentColor">
                            <path d="M127.961 0l-2.795 9.5v275.668l2.795 2.79 127.962-75.638z" fill-opacity="0.6"/>
                            <path d="M127.962 0L0 212.32l127.962 75.639V154.158z" fill-opacity="0.45"/>
                            <path d="M127.961 312.187l-1.575 1.92v98.199l1.575 4.6L256 236.587z" fill-opacity="0.6"/>
                            <path d="M127.962 416.905v-104.72L0 236.585z" fill-opacity="0.45"/>
                            <path d="M127.961 287.958l127.96-75.637-127.96-58.162z" fill-opacity="0.2"/>
                            <path d="M0 212.32l127.96 75.638v-133.8z" fill-opacity="0.1"/>
                        </svg>
                        {% elif asset == "BTC" %}
                        <span class="text-2xl font-bold text-white">₿</span>
                        {% else %}
                        <span class="text-2xl font-bold text-white">{{ asset[0] }}</span>
                        {% endif %}
                    </div>
                    
                    <!-- Title and Volume -->
                    <div class="flex-1">
                        <h2 class="text-xl font-bold text-gray-900 mb-1">{{ event.title }}</h2>
                        <div class="flex items-center space-x-3 text-sm text-gray-500">
                            <span>${{ "{:,.0f}".format(summary.total_cost * 10) }} Vol.</span>
                        </div>
                    </div>
                </div>
                
                <!-- Timer + Refresh -->
                <div class="flex flex-col items-end space-y-3 text-sm">
                    <div class="flex items-center space-x-4">
                        <div class="text-center">
                            <div class="text-2xl font-bold text-gray-900">{{ countdown.days if countdown else "--" }}</div>
                            <div class="text-xs text-gray-500 uppercase">Days</div>
                        </div>
                        <div class="text-center">
                            <div class="text-2xl font-bold text-gray-900">{{ countdown.hours if countdown else "--" }}</div>
                            <div class="text-xs text-gray-500 uppercase">Hrs</div>
                        </div>
                        <div class="text-center">
                            <div class="text-2xl font-bold text-gray-900">{{ countdown.minutes if countdown else "--" }}</div>
                            <div class="text-xs text-gray-500 uppercase">Mins</div>
                        </div>
                    </div>
                    <form method="get" action="/mirror" class="flex items-center space-x-2">
                        <input type="hidden" name="slug" value="{{ slug }}">
                        <input type="hidden" name="asset" value="{{ asset }}">
                        <input type="hidden" name="budget" value="{{ budget }}">
                        <input type="hidden" name="bias" value="{{ bias }}">
                        <input type="hidden" name="refresh" value="true">
                        {% if risk_cap is not none %}
                        <input type="hidden" name="risk_cap" value="{{ risk_cap }}">
                        {% endif %}
                        <button type="submit" class="inline-flex items-center px-3 py-1.5 rounded-md bg-blue-600 text-white text-xs font-semibold hover:bg-blue-700 transition">
                            <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v6h6M20 20v-6h-6M5 19a9 9 0 1110.49-9.5" />
                            </svg>
                            Refresh Data
                        </button>
                    </form>
                    <div class="text-xs text-gray-400">
                        Last updated: {{ last_updated }}
                    </div>
                </div>
            </div>
            
            <!-- End Date Badge and Polymarket Link -->
            <div class="flex items-center justify-between pt-3 border-t border-gray-100">
                <div class="flex items-center space-x-2 text-sm">
                    <div class="flex items-center space-x-1 bg-gray-100 rounded-full px-3 py-1">
                        <svg class="w-4 h-4 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                        <span class="text-xs font-medium text-gray-700">12 AM Oct 6</span>
                    </div>
                </div>
                
                <a href="https://polymarket.com/event/{{ event.slug }}" target="_blank" class="flex items-center space-x-1 text-gray-400 hover:text-gray-600 transition-colors">
                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M11 3a1 1 0 100 2h2.586l-6.293 6.293a1 1 0 101.414 1.414L15 6.414V9a1 1 0 102 0V4a1 1 0 00-1-1h-5z"/>
                        <path d="M5 5a2 2 0 00-2 2v8a2 2 0 002 2h8a2 2 0 002-2v-3a1 1 0 10-2 0v3H5V7h3a1 1 0 000-2H5z"/>
                    </svg>
                    <span class="text-xs font-medium">Polymarket</span>
                </a>
            </div>
        </div>

        <div class="bg-white shadow rounded-lg overflow-hidden">
            <div class="overflow-x-auto">
                <!-- Upside Markets (Above Anchor) -->
                {% set sorted_upside = upside_markets | selectattr('strike') | sort(attribute='strike.K', reverse=True) | list %}
                {% if not sorted_upside %}
                {% set sorted_upside = event.markets | selectattr('strike') | selectattr('strike.K', '>', anchor) | sort(attribute='strike.K', reverse=True) | list %}
                {% endif %}
                {% if sorted_upside %}
                <div class="border-b-2 border-gray-200">
                    <table class="min-w-full w-full">
                        <tbody class="divide-y divide-gray-100">
                            {% for market in sorted_upside %}
                            {% set order_match = orders | selectattr('strike', 'equalto', market.strike.K) | list %}
                            {% set has_order = order_match | length > 0 %}
                            {% set pair_info = pairs.get(market.strike.K) %}
                            {% set strike_value = market.strike.K if market.strike else None %}
                            {% set is_highlight = strike_value is not none and strike_value in highlight_strikes %}
                            {% set row_classes = "hover:bg-gray-50" %}
                            {% if has_order and not is_highlight %}
                                {% set row_classes = row_classes + " bg-gray-100" %}
                            {% endif %}
                            {% if is_highlight %}
                                {% set row_classes = row_classes + " bg-amber-50 ring-2 ring-amber-300" %}
                            {% endif %}
                            <tr class="{{ row_classes }}">
                                <td class="px-6 py-3 whitespace-nowrap w-24">
                                    <div class="flex items-center space-x-1">
                                        <span class="text-xs text-gray-500">↑</span>
                                        <span class="font-mono text-sm font-bold text-gray-900">${{ "{:,.0f}".format(market.strike.K) }}</span>
                                    </div>
                                    <div class="text-xs text-gray-400">Vol. $1k</div>
                                </td>
                                <td class="px-4 py-3 text-center w-20">
                                    <span class="text-2xl font-bold text-gray-900">{{ "{:.0f}".format(market.yes_price * 100) }}%</span>
                                </td>
                                <td class="px-4 py-3 text-right">
                                    <div class="flex items-center justify-end space-x-2">
                                        <button class="w-28 px-3 py-1 bg-green-100 text-green-700 rounded-md text-sm font-medium hover:bg-green-200">
                                            Buy Yes {{ market.yes_price | cents }}¢
                                        </button>
                                        <button class="w-28 px-3 py-1 bg-red-100 text-red-700 rounded-md text-sm font-medium hover:bg-red-200">
                                            Buy No {{ market.no_price | cents }}¢
                                        </button>
                                        {% if pair_info %}
                                        {% set yes_units = 200 %}
                                        {% set no_units = 100 %}
                                        {% set yes_label = "YES $" ~ "{:,.0f}".format(pair_info.yes_strike if pair_info.yes_strike is not none else market.strike.K) %}
                                        {% set no_label = "NO $" ~ "{:,.0f}".format(pair_info.no_strike if pair_info.no_strike is not none else market.strike.K) %}
                                        {% set scenario_classes = "ml-3 px-2 py-1 bg-gray-50 border border-gray-300 rounded text-xs text-left text-gray-600 min-w-[280px] hover:border-blue-300 focus:ring-2 focus:ring-blue-400 focus:outline-none transition" %}
                                        {% if is_highlight %}
                                            {% set scenario_classes = "ml-3 px-2 py-1 bg-amber-100 border border-amber-400 rounded text-xs text-left text-amber-800 min-w-[280px] hover:border-amber-500 focus:ring-2 focus:ring-amber-400 focus:outline-none transition" %}
                                        {% endif %}
                                        <button
                                            type="button"
                                            class="{{ scenario_classes }}"
                                            data-scenario="true"
                                            data-anchor="{{ anchor }}"
                                            data-asset="{{ asset }}"
                                            data-yes-price="{{ pair_info.yes_price | float }}"
                                            data-no-price="{{ pair_info.no_price | float }}"
                                            data-yes-strike="{{ pair_info.yes_strike if pair_info.yes_strike is not none else market.strike.K }}"
                                            data-no-strike="{{ pair_info.no_strike if pair_info.no_strike is not none else market.strike.K }}"
                                            data-yes-units="{{ yes_units }}"
                                            data-no-units="{{ no_units }}"
                                            data-yes-label="{{ yes_label | e }}"
                                            data-no-label="{{ no_label | e }}"
                                            data-pair-label="{{ market.question | e }}"
                                            data-direction="{{ pair_info.direction }}"
                                        >
                                            <span class="block">
                                                Yes {{ pair_info.yes_price | cents }}¢ + No {{ pair_info.no_price | cents }}¢ = {{ "{:.0f}".format(pair_info.cost * 100) }}¢
                                                <span class="text-green-600 ml-1">Pnl {{ "{:.0f}".format(pair_info.pnl * 100) }}¢</span>
                                                <span class="text-blue-600 ml-1">APY {{ "{:.0f}".format(pair_info.apy) }}%</span>
                                            </span>
                                        </button>
                                        {% else %}
                                        <div class="ml-3 px-2 py-1 bg-gray-50 border border-gray-300 rounded text-xs text-gray-500 min-w-[280px]">
                                            Yes {{ 0 | cents }}¢ + No {{ 0 | cents }}¢ = {{ 0 | cents }}¢
                                            <span class="ml-1">Pnl {{ 0 | cents }}¢</span>
                                            <span class="ml-1">APY 0%</span>
                                        </div>
                                        {% endif %}
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    <div class="px-6 py-2 bg-gray-50 border-t border-gray-200">
                        <span class="text-xs font-semibold text-gray-600 uppercase">Upside (Above ${{ "{:,.0f}".format(anchor) }})</span>
                    </div>
                </div>
                {% endif %}

                <!-- Current Anchor Price Line -->
                <div class="py-3 px-6 bg-blue-50 border-y-2 border-blue-300">
                    <div class="flex items-center justify-center space-x-2">
                        <svg class="w-4 h-4 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"/>
                        </svg>
                        <span class="text-sm font-bold text-blue-900">Current Anchor: ${{ "{:,.2f}".format(anchor) }}</span>
                    </div>
                </div>

                <!-- Downside Markets (Below Anchor) -->
                {% set sorted_downside = downside_markets | selectattr('strike') | sort(attribute='strike.K', reverse=True) | list %}
                {% if not sorted_downside %}
                {% set sorted_downside = event.markets | selectattr('strike') | selectattr('strike.K', '<=', anchor) | sort(attribute='strike.K', reverse=True) | list %}
                {% endif %}
                {% if sorted_downside %}
                <div>
                    <div class="px-6 py-2 bg-gray-50">
                        <span class="text-xs font-semibold text-gray-600 uppercase">Downside (Below ${{ "{:,.0f}".format(anchor) }})</span>
                    </div>
                    <table class="min-w-full w-full">
                        <tbody class="divide-y divide-gray-100">
                            {% for market in sorted_downside %}
                            {% set order_match = orders | selectattr('strike', 'equalto', market.strike.K) | list %}
                            {% set has_order = order_match | length > 0 %}
                            {% set pair_info = pairs.get(market.strike.K) %}
                            {% set strike_value = market.strike.K if market.strike else None %}
                            {% set is_highlight = strike_value is not none and strike_value in highlight_strikes %}
                            {% set row_classes = "hover:bg-gray-50" %}
                            {% if has_order and not is_highlight %}
                                {% set row_classes = row_classes + " bg-gray-100" %}
                            {% endif %}
                            {% if is_highlight %}
                                {% set row_classes = row_classes + " bg-amber-50 ring-2 ring-amber-300" %}
                            {% endif %}
                            <tr class="{{ row_classes }}">
                                <td class="px-6 py-3 whitespace-nowrap w-24">
                                    <div class="flex items-center space-x-1">
                                        <span class="text-xs text-gray-500">↓</span>
                                        <span class="font-mono text-sm font-bold text-gray-900">${{ "{:,.0f}".format(market.strike.K) }}</span>
                                    </div>
                                    <div class="text-xs text-gray-400">Vol. $1k</div>
                                </td>
                                <td class="px-4 py-3 text-center w-20">
                                    <span class="text-2xl font-bold text-gray-900">{{ "{:.0f}".format(market.yes_price * 100) }}%</span>
                                </td>
                                <td class="px-4 py-3 text-right">
                                    <div class="flex items-center justify-end space-x-2">
                                        <button class="w-28 px-3 py-1 bg-green-100 text-green-700 rounded-md text-sm font-medium hover:bg-green-200">
                                            Buy Yes {{ market.yes_price | cents }}¢
                                        </button>
                                        <button class="w-28 px-3 py-1 bg-red-100 text-red-700 rounded-md text-sm font-medium hover:bg-red-200">
                                            Buy No {{ market.no_price | cents }}¢
                                        </button>
                                        {% if pair_info %}
                                        {% set yes_units = 200 %}
                                        {% set no_units = 100 %}
                                        {% set yes_label = "YES $" ~ "{:,.0f}".format(pair_info.yes_strike if pair_info.yes_strike is not none else market.strike.K) %}
                                        {% set no_label = "NO $" ~ "{:,.0f}".format(pair_info.no_strike if pair_info.no_strike is not none else market.strike.K) %}
                                        {% set scenario_classes = "ml-3 px-2 py-1 bg-gray-50 border border-gray-300 rounded text-xs text-left text-gray-600 min-w-[280px] hover:border-blue-300 focus:ring-2 focus:ring-blue-400 focus:outline-none transition" %}
                                        {% if is_highlight %}
                                            {% set scenario_classes = "ml-3 px-2 py-1 bg-amber-100 border border-amber-400 rounded text-xs text-left text-amber-800 min-w-[280px] hover:border-amber-500 focus:ring-2 focus:ring-amber-400 focus:outline-none transition" %}
                                        {% endif %}
                                        <button
                                            type="button"
                                            class="{{ scenario_classes }}"
                                            data-scenario="true"
                                            data-anchor="{{ anchor }}"
                                            data-asset="{{ asset }}"
                                            data-yes-price="{{ pair_info.yes_price | float }}"
                                            data-no-price="{{ pair_info.no_price | float }}"
                                            data-yes-strike="{{ pair_info.yes_strike if pair_info.yes_strike is not none else market.strike.K }}"
                                            data-no-strike="{{ pair_info.no_strike if pair_info.no_strike is not none else market.strike.K }}"
                                            data-yes-units="{{ yes_units }}"
                                            data-no-units="{{ no_units }}"
                                            data-yes-label="{{ yes_label | e }}"
                                            data-no-label="{{ no_label | e }}"
                                            data-pair-label="{{ market.question | e }}"
                                            data-direction="{{ pair_info.direction }}"
                                        >
                                            <span class="block">
                                                Yes {{ pair_info.yes_price | cents }}¢ + No {{ pair_info.no_price | cents }}¢ = {{ "{:.0f}".format(pair_info.cost * 100) }}¢
                                                <span class="text-green-600 ml-1">Pnl {{ "{:.0f}".format(pair_info.pnl * 100) }}¢</span>
                                                <span class="text-blue-600 ml-1">APY {{ "{:.0f}".format(pair_info.apy) }}%</span>
                                            </span>
                                        </button>
                                        {% else %}
                                        <div class="ml-3 px-2 py-1 bg-gray-50 border border-gray-300 rounded text-xs text-gray-500 min-w-[280px]">
                                            Yes {{ 0 | cents }}¢ + No {{ 0 | cents }}¢ = {{ 0 | cents }}¢
                                            <span class="ml-1">Pnl {{ 0 | cents }}¢</span>
                                            <span class="ml-1">APY 0%</span>
                                        </div>
                                        {% endif %}
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Right Column: Strategy & Orders -->
    <div class="lg:w-[1000px] space-y-6 mt-6 lg:mt-0">
        <div class="bg-white shadow rounded-lg p-5">
            <div class="flex items-baseline justify-between">
                <span class="text-sm font-medium text-gray-500 uppercase tracking-wide">Current Anchor</span>
                <span class="text-xs text-gray-400">{{ asset }}/USDT</span>
            </div>
            <div class="mt-3 flex items-end space-x-2">
                <span class="text-3xl font-bold text-blue-600">${{ "{:,.2f}".format(anchor) }}</span>
                <span class="text-sm text-gray-500">spot</span>
            </div>
        </div>

        <div id="scenario-panel" class="bg-white shadow rounded-lg p-6">
            <div class="flex items-start justify-between">
                <div>
                    <h3 class="text-lg font-semibold text-gray-900">Scenario Analysis</h3>
                    <p class="text-xs text-gray-500 mt-1">Нажмите на комбинацию YES/NO, чтобы увидеть прогноз по ценовым сценариям.</p>
                </div>
                <button
                    type="button"
                    id="scenario-clear"
                    class="text-xs text-gray-400 hover:text-blue-600 transition"
                >
                    Очистить
                </button>
            </div>
            <div id="scenario-content" class="mt-4 text-sm text-gray-500">
                Нет выбранной комбинации.
            </div>
        </div>
    </div>
</div>

<script>
function formatScenarioPrice(value) {
    if (value >= 1000) {
        return value.toLocaleString(undefined, { maximumFractionDigits: 0 });
    }
    return value.toLocaleString(undefined, { maximumFractionDigits: 2 });
}

function formatShareValue(value) {
    return value.toFixed(2);
}

function formatDollarValue(value) {
    return value.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 });
}

function copyOrdersJSON() {
    const orders = [
        {% for order in orders %}
        {
            "market_id": "{{ order.market_id }}",
            "question": "{{ order.question }}",
            "strike": {{ order.strike if order.strike else 'null' }},
            "side": "{{ order.side }}",
            "units": {{ order.units }},
            "limit_price": {{ order.limit_price }},
            "cost": {{ order.cost }},
            "max_profit": {{ order.max_profit }},
            "max_loss": {{ order.max_loss }}
        }{% if not loop.last %},{% endif %}
        {% endfor %}
    ];
    const json = JSON.stringify(orders, null, 2);
    navigator.clipboard.writeText(json).then(() => {
        alert('Orders copied to clipboard!');
    });
}

async function requestScenario(payload) {
    const response = await fetch("/api/pair-scenario", {
        method: "POST",
        headers: {
            "Content-Type": "application/json"
        },
        body: JSON.stringify(payload)
    });

    if (!response.ok) {
        throw new Error("Не удалось получить сценарий");
    }

    return response.json();
}

function renderScenarioContent(container, data) {
    const highlightIndex = data.highlight_index;
    const bodyRows = data.rows.map((row) => {
        const valueCells = row.values.map((value, idx) => {
            const highlight = idx === highlightIndex ? 'bg-yellow-100 font-semibold' : '';
            return `<td class="px-3 py-2 text-center border-b border-gray-200 ${highlight}">${formatShareValue(value)}</td>`;
        }).join("");

        return `
            <tr>
                <th scope="row" class="px-3 py-2 text-left font-medium text-gray-700 border-b border-gray-200">${row.label}</th>
                <td class="px-3 py-2 text-center text-gray-600 border-b border-gray-200">${row.quantity}</td>
                ${valueCells}
            </tr>
        `;
    }).join("");

    const returnCells = data.return_row.map((value, idx) => {
        const highlight = idx === highlightIndex ? 'bg-yellow-100 font-semibold' : '';
        return `<td class="px-3 py-2 text-center border-t border-gray-200 ${highlight}">${formatDollarValue(value)}</td>`;
    }).join("");

    const directionBadge = data.direction
        ? `<span class="ml-2 inline-flex items-center px-2 py-0.5 rounded text-xs font-medium ${data.direction === 'upside' ? 'bg-blue-100 text-blue-800' : 'bg-orange-100 text-orange-800'}">${data.direction.toUpperCase()}</span>`
        : "";

    const anchorLabel = formatScenarioPrice(data.anchor_price || (data.prices?.[highlightIndex] ?? 0));

    const headerRow = `
        <tr>
            <th class="px-3 py-2 text-left border-b border-gray-200">Маркет</th>
            <th class="px-3 py-2 text-center border-b border-gray-200">Кол-во</th>
            ${data.prices.map((price, idx) => {
                const highlight = idx === highlightIndex ? 'bg-yellow-100 font-semibold' : '';
                const label = idx === highlightIndex ? anchorLabel : formatScenarioPrice(price);
                return `<th class="px-3 py-2 text-center border-b border-gray-200 ${highlight}">${label}</th>`;
            }).join("")}
        </tr>
    `;

    container.innerHTML = `
        <div class="flex items-baseline justify-between mb-4">
            <div>
                <div class="text-sm font-semibold text-gray-800">${data.pair_label || 'Выбранная комбинация'}</div>
                <div class="text-xs text-gray-500">Инвестировано: $${formatDollarValue(data.invested)}</div>
            </div>
            ${directionBadge}
        </div>
        <div class="overflow-x-auto">
            <table class="min-w-full text-xs text-gray-700 border border-gray-200 rounded">
                <thead class="bg-gray-50">
                    ${headerRow}
                </thead>
                <tbody>
                    ${bodyRows}
                </tbody>
                <tfoot class="bg-gray-50">
                    <tr>
                        <th class="px-3 py-2 text-left font-medium text-gray-700 border-t border-gray-200">Return, $</th>
                        <td class="px-3 py-2 text-center font-medium text-gray-700 border-t border-gray-200">—</td>
                        ${returnCells}
                    </tr>
                </tfoot>
            </table>
        </div>
        <p class="mt-3 text-xs text-gray-500">
            Приближенная оценка цен Polymarket при изменении спота ±5%. Используется сглаженная логистическая модель; скорректируйте вручную при необходимости.
        </p>
    `;
}

document.addEventListener("DOMContentLoaded", () => {
    const scenarioButtons = document.querySelectorAll('[data-scenario="true"]');
    const scenarioContent = document.getElementById("scenario-content");
    const scenarioClear = document.getElementById("scenario-clear");

    if (scenarioButtons.length > 0 && scenarioContent) {
        scenarioButtons.forEach((button) => {
            button.addEventListener("click", async () => {
                const dataset = button.dataset;
                const yesStrikeValue = dataset.yesStrike;
                const noStrikeValue = dataset.noStrike;
                const yesUnitsRaw = parseInt(dataset.yesUnits || "0", 10);
                const noUnitsRaw = parseInt(dataset.noUnits || "0", 10);
                const anchorValue = parseFloat(dataset.anchor);
                const yesPriceValue = parseFloat(dataset.yesPrice);
                const noPriceValue = parseFloat(dataset.noPrice);
                const payload = {
                    asset: dataset.asset,
                    anchor: Number.isNaN(anchorValue) ? 0 : anchorValue,
                    yes_price: Number.isNaN(yesPriceValue) ? 0 : yesPriceValue,
                    no_price: Number.isNaN(noPriceValue) ? 0 : noPriceValue,
                    yes_units: Number.isNaN(yesUnitsRaw) ? 0 : yesUnitsRaw,
                    no_units: Number.isNaN(noUnitsRaw) ? 0 : noUnitsRaw,
                    yes_strike: yesStrikeValue && yesStrikeValue !== "None" ? parseFloat(yesStrikeValue) : null,
                    no_strike: noStrikeValue && noStrikeValue !== "None" ? parseFloat(noStrikeValue) : null,
                    yes_label: dataset.yesLabel || "",
                    no_label: dataset.noLabel || "",
                    pair_label: dataset.pairLabel || "",
                    direction: dataset.direction || ""
                };

                scenarioContent.classList.remove("text-gray-500");
                scenarioContent.innerHTML = '<div class="text-sm text-gray-500">Считаем сценарии…</div>';

                try {
                    const data = await requestScenario(payload);
                    renderScenarioContent(scenarioContent, data);
                } catch (error) {
                    console.error(error);
                    scenarioContent.innerHTML = '<div class="text-sm text-red-500">Не удалось построить сценарий.</div>';
                }
            });
        });
    }

    if (scenarioClear && scenarioContent) {
        scenarioClear.addEventListener("click", () => {
            scenarioContent.classList.add("text-gray-500");
            scenarioContent.innerHTML = "Нет выбранной комбинации.";
        });
    }
});
</script>
{% endblock %}
